{
  "openapi": "3.0.3",
  "info": {
    "title": "Backend API (Productos, Usuarios y Votos)",
    "version": "1.0.0",
    "description": "API para gestionar usuarios (CRUD), productos (listado y votación legacy) y votos (registro detallado). Autenticación por x-api-key."
  },
  "servers": [
    {
      "url": "https://backend-apiv4-production.up.railway.app/api",
      "description": "Producción (Railway) - prefijo /api incluido"
    }
  ],
  "security": [
    { "ApiKeyAuth": [] }
  ],
  "paths": {
    "/health": {
      "get": {
        "summary": "Healthcheck",
        "operationId": "health",
        "responses": {
          "200": {
            "description": "OK (servidor operativo)"
          }
        },
        "security": []
      }
    },

    /* =========================
       USUARIOS (cliente_usuario)
       ========================= */
    "/users": {
      "get": {
        "summary": "Listar usuarios",
        "operationId": "listUsers",
        "responses": {
          "200": {
            "description": "Listado de usuarios",
            "content": {
              "application/json": {
                "schema": { "type": "array", "items": { "$ref": "#/components/schemas/User" } }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Crear usuario",
        "operationId": "createUser",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/NewUser" },
              "examples": {
                "ejemplo": {
                  "value": {
                    "nombres": "Ana Milena",
                    "apellidos": "Arbelaez Taborda",
                    "email": "ana@mail.com",
                    "telefono": "12345678"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Usuario creado",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/User" } }
            }
          },
          "400": { "description": "Datos inválidos" },
          "409": { "description": "Correo duplicado (email ya existe)" }
        }
      }
    },

    "/users/{id_usuario}": {
      "get": {
        "summary": "Obtener usuario por ID",
        "operationId": "getUserById",
        "parameters": [
          { "in": "path", "name": "id_usuario", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Usuario",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/User" } } }
          },
          "404": { "description": "No encontrado" }
        }
      },
      "put": {
        "summary": "Actualizar usuario",
        "operationId": "updateUser",
        "parameters": [
          { "in": "path", "name": "id_usuario", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UpdateUser" } } }
        },
        "responses": {
          "200": {
            "description": "Usuario actualizado",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/User" } } }
          },
          "400": { "description": "Datos inválidos" },
          "404": { "description": "No encontrado" },
          "409": { "description": "Correo duplicado" }
        }
      },
      "delete": {
        "summary": "Eliminar usuario",
        "operationId": "deleteUser",
        "parameters": [
          { "in": "path", "name": "id_usuario", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "204": { "description": "Eliminado (sin cuerpo)" },
          "404": { "description": "No encontrado" }
        }
      }
    },

    "/users/email/{email}": {
      "get": {
        "summary": "Buscar usuario por email",
        "operationId": "getUserByEmail",
        "parameters": [
          { "in": "path", "name": "email", "required": true, "schema": { "type": "string", "format": "email" } }
        ],
        "responses": {
          "200": {
            "description": "Usuario encontrado",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/User" } } }
          },
          "404": { "description": "Usuario no encontrado" }
        }
      }
    },

    /* ==============
       PRODUCTOS (DB)
       ============== */
    "/productos-db": {
      "get": {
        "summary": "Listar productos",
        "operationId": "listProductsDb",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "required": false,
            "schema": { "type": "string" },
            "description": "Filtro opcional por nombre (si implementado)"
          }
        ],
        "responses": {
          "200": {
            "description": "Listado de productos",
            "content": {
              "application/json": {
                "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Product" } }
              }
            }
          }
        }
      }
    },

    /* LEGACY: Votar por nombre (temporalmente activo) */
    "/productos-db/votar/{nombre}": {
      "put": {
        "summary": "LEGACY - Votar producto por nombre (+1)",
        "operationId": "voteProductByNameLegacy",
        "parameters": [
          { "in": "path", "name": "nombre", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "200": {
            "description": "Votación incrementada",
            "content": {
              "application/json": {
                "schema": { "type": "object", "properties": { "ok": { "type": "boolean" } } }
              }
            }
          },
          "404": { "description": "Producto no encontrado" }
        }
      }
    },

    /* =====
       VOTOS
       ===== */
    "/votos": {
      "post": {
        "summary": "Registrar voto (detalle_votos)",
        "operationId": "createVote",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/NewVote" },
              "examples": {
                "ejemplo": { "value": { "id_producto": 1, "id_votante": 1 } }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Voto registrado",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Vote" } } }
          },
          "400": { "description": "Datos incompletos" },
          "409": { "description": "Violación de FK (producto o votante no existen)" }
        }
      }
    },

    "/votos/usuario/{id_votante}": {
      "get": {
        "summary": "Listar votos por usuario",
        "operationId": "listVotesByUser",
        "parameters": [
          { "in": "path", "name": "id_votante", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Listado de votos del usuario",
            "content": {
              "application/json": {
                "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Vote" } }
              }
            }
          }
        }
      }
    }
  },

  "components": {
    "securitySchemes": {
      "ApiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "x-api-key",
        "description": "Llave para autenticar llamadas (Power Apps/Front)."
      }
    },
    "schemas": {
      "User": {
        "type": "object",
        "properties": {
          "id_usuario": { "type": "integer" },
          "nombres": { "type": "string" },
          "apellidos": { "type": "string" },
          "email": { "type": "string", "format": "email" },
          "telefono": { "type": "string" },
          "creado_en": { "type": "string", "format": "date-time" }
        },
        "required": ["id_usuario", "nombres", "apellidos", "email", "telefono", "creado_en"]
      },
      "NewUser": {
        "type": "object",
        "properties": {
          "nombres": { "type": "string", "maxLength": 50 },
          "apellidos": { "type": "string", "maxLength": 50 },
          "email": { "type": "string", "format": "email", "maxLength": 80 },
          "telefono": { "type": "string", "maxLength": 30 }
        },
        "required": ["nombres", "apellidos", "email", "telefono"]
      },
      "UpdateUser": {
        "type": "object",
        "properties": {
          "nombres": { "type": "string", "maxLength": 50 },
          "apellidos": { "type": "string", "maxLength": 50 },
          "email": { "type": "string", "format": "email", "maxLength": 80 },
          "telefono": { "type": "string", "maxLength": 30 }
        },
        "required": ["nombres", "apellidos", "email", "telefono"]
      },
      "Product": {
        "type": "object",
        "properties": {
          "id_producto": { "type": "integer" },
          "nombre": { "type": "string" },
          "foto": { "type": "string" },
          "votacion": { "type": "integer" }
        },
        "required": ["id_producto", "nombre", "votacion"]
      },
      "Vote": {
        "type": "object",
        "properties": {
          "id_voto": { "type": "integer" },
          "id_producto": { "type": "integer" },
          "fecha_voto": { "type": "string", "format": "date-time" },
          "id_votante": { "type": "integer" }
        },
        "required": ["id_voto", "id_producto", "fecha_voto", "id_votante"]
      },
      "NewVote": {
        "type": "object",
        "properties": {
          "id_producto": { "type": "integer" },
          "id_votante": { "type": "integer" }
        },
        "required": ["id_producto", "id_votante"]
      }
    }
  }
}

